/* Copyright 2015 Samsung Electronics Co., LTD * * Licensed under the Apache License, Version 2.0 (the "License"); * you may not use this file except in compliance with the License. * You may obtain a copy of the License at * *     http://www.apache.org/licenses/LICENSE-2.0 * * Unless required by applicable law or agreed to in writing, software * distributed under the License is distributed on an "AS IS" BASIS, * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. * See the License for the specific language governing permissions and * limitations under the License. */package org.gearvrf.modelviewer2;import org.gearvrf.GVRAndroidResource;import org.gearvrf.GVRContext;import org.gearvrf.GVREyePointeeHolder;import org.gearvrf.GVRMeshEyePointee;import org.gearvrf.GVRPicker;import org.gearvrf.GVRRenderData;import org.gearvrf.GVRScene;import org.gearvrf.GVRSceneObject;import org.gearvrf.GVRMain;import org.gearvrf.GVRTexture;import org.gearvrf.scene_objects.GVRModelSceneObject;import org.gearvrf.util.VRTouchPadGestureDetector.SwipeDirection;import android.os.Environment;import android.util.Log;import android.view.MotionEvent;import java.io.File;import java.io.IOException;import java.util.ArrayList;public class ModelViewer2Manager extends GVRMain {    private static final String TAG = "DEBUG";	private GVRContext mGVRContext;    private GVRModelSceneObject mRoom;    private GVRModelSceneObject mRoomWithMenu;    private ArrayList<GVRModelSceneObject> allModels = null;    private ArrayList<GVRSceneObject> thumbnails =  new ArrayList<GVRSceneObject>();    private ArrayList<GVRSceneObject> currentModels = new ArrayList<GVRSceneObject>();    private final String mRoomPath = "room.fbx";    private GVRScene scene;    private GVRSceneObject mHeadTracker = null;    private ArrayList<String> models = null;    private boolean mIsSingleTapped = false;    private GVRModelSceneObject current = null;    private static final int gSlots = 2;    private int gStart = 0;    private String sEnvironmentPath = Environment.getExternalStorageDirectory().getPath();    private GVRModelSceneObject loadFbxFile(GVRContext gvrContext, String fbxFile){        try {            return gvrContext.loadModel(fbxFile);        }catch (IOException e) {            e.printStackTrace();        }        return null;    }    private ArrayList<GVRModelSceneObject> loadAllModels(){        ArrayList<GVRModelSceneObject> allModels = new ArrayList<GVRModelSceneObject>();        try {            // Add All the Extensions you want to load            ArrayList<String> extensions = new ArrayList<String>();            extensions.add(".fbx");            extensions.add(".3ds");            extensions.add(".dae");            // Reads the List of Files from specified folder having extension specified in extensions.            // Please place your models by creating GVRModelViewer2 folder in your internal phone memory            CardReader cRObject = new CardReader(sEnvironmentPath+"/GVRModelViewer2", extensions);            File list[] = cRObject.getModels();            // Adds all the models            for (File file : list){                Log.e("FBx File", file.getAbsolutePath());                allModels.add(mGVRContext.loadModelFromSD("GVRModelViewer2/"+file.getName()));            }            return allModels;        }catch (IOException e) {            e.printStackTrace();        }        return null;    }    private void transformAllModels(){        for(int i = 0; i < allModels.size(); i++){            allModels.get(i).getTransform().setPosition(0.0f, 0.0f, -12.4f);        }    }    private GVRTexture loadTexture(GVRContext gvrContext, String imageFile){        try {            return gvrContext.loadTexture(new GVRAndroidResource(gvrContext, imageFile));        }catch (IOException e) {            e.printStackTrace();        }        return null;    }    private void addThumbnailsAndPicker(ArrayList<GVRModelSceneObject> allModels){        float xPosition = 0.0f;        GVRTexture icon = null;        try {            icon = mGVRContext.loadTexture(new GVRAndroidResource( mGVRContext, "play-active.png"));        } catch (IOException e) {            Log.e("ERROR", "Unable to load texture");            e.printStackTrace();        }        for(GVRModelSceneObject mModel : allModels){            Log.d(TAG, "Creating Thumbnails");            GVRSceneObject temp = new GVRSceneObject(mGVRContext, mGVRContext.createQuad(1.5f, 1.5f), icon);            temp.getRenderData().getMaterial().setTexture("inactive_back", icon);            GVREyePointeeHolder playPauseHolder = new GVREyePointeeHolder(mGVRContext);            playPauseHolder.addPointee(new GVRMeshEyePointee(mGVRContext,temp.getRenderData().getMesh()));            temp.attachEyePointeeHolder(playPauseHolder);            thumbnails.add(temp);        }    }    private void addAllThumbNails(){        Log.d(TAG, "Adding all thumbnails to the Room");        int lSlots = gSlots;        int count = thumbnails.size();        float xPosition = 0.0f;        for(GVRSceneObject oneChild : currentModels){                mRoomWithMenu.removeChildObject(oneChild);        }        for(int i = gStart; i < count;){            thumbnails.get(i).getTransform().setPosition(xPosition, 2.0f, -6.0f);            xPosition += 2.0;            mRoomWithMenu.addChildObject(thumbnails.get(i));            currentModels.add(thumbnails.get(i));            lSlots--;            i = (i + 1) % count;            gStart = i;            if(lSlots == 0){                break;            }        }    }	@Override	public void onInit(GVRContext gvrContext) {		mGVRContext = gvrContext;		scene = gvrContext.getNextMainScene();        mGVRContext.getMainScene().getMainCameraRig().getOwnerObject()               .getTransform().setPosition(4.0f, 0.0f, 0.0f);        // Head Tracker        GVRTexture headTrackerTexture = loadTexture(mGVRContext, "head-tracker.png");        mHeadTracker = new GVRSceneObject(gvrContext,                gvrContext.createQuad(0.5f, 0.5f), headTrackerTexture);        mHeadTracker.getTransform().setPositionZ(-9.0f);        mHeadTracker.getRenderData().setRenderingOrder(                GVRRenderData.GVRRenderingOrder.OVERLAY);        mHeadTracker.getRenderData().setDepthTest(false);        mHeadTracker.getRenderData().setRenderingOrder(100000);        scene.getMainCameraRig().addChildObject(mHeadTracker);        // Loads the Room model        mRoom = loadFbxFile(gvrContext, mRoomPath);        // Loads all the model from SD Card        allModels = loadAllModels();        transformAllModels();        // Add Pickers and Thumbnails for each model        addThumbnailsAndPicker(allModels);        // Set Transformations        mRoom.getTransform().setPosition(0.0f, -0.5f, 0.0f);        // Add All Thumbnails        mRoomWithMenu = loadFbxFile(gvrContext, mRoomPath);        mRoomWithMenu.getTransform().setPosition(0.0f, -0.5f, 0.0f);        addAllThumbNails();        // Adding only Room to the scene        scene.addSceneObject(mRoomWithMenu);    }	@Override	public void onStep() {            boolean isSingleTapped = mIsSingleTapped;            mIsSingleTapped = false;            GVREyePointeeHolder[] pickedHolders = null;            if (pickedHolders == null) {                pickedHolders = GVRPicker.pickScene(mGVRContext.getMainScene());            }            if(isSingleTapped){                boolean closeFlag = false;                for (GVREyePointeeHolder holder : pickedHolders) {                    int index = 0;                    for(GVRSceneObject temp: thumbnails){                        if (holder.equals(temp.getEyePointeeHolder())) {                            if(current != null)                                mRoom.removeChildObject(current);                            mRoom.addChildObject(allModels.get(index));                            scene.removeSceneObject(mRoomWithMenu);                            scene.addSceneObject(mRoom);                            closeFlag = true;                            current = allModels.get(index);                            break;                        }                        index++;                    }                }                if(!closeFlag){                    scene.removeSceneObject(mRoom);                    scene.addSceneObject(mRoomWithMenu);                }            }    }    public void onSingleTap(MotionEvent e) {        Log.d(TAG, "On Single Touch Received");        mIsSingleTapped = true;    }    public void onSwipe(MotionEvent e, SwipeDirection swipeDirection,                        float velocityX, float velocityY){        if(swipeDirection ==  SwipeDirection.Forward){            addAllThumbNails();            Log.d("SWIPE", "Swipped Forward");        }        else if(swipeDirection ==  SwipeDirection.Backward){            Log.d("SWIPE", "Swipped Backward");        }        else {            Log.d("SWIPE", "Unknown Swipe");        }    }}